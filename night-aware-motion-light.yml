blueprint:
  name: Motion-Activated Light with Night Settings
    description: Turn on a light when motion is detected, with specific brightness for night hours.
      domain: automation
        input:
            motion_entity:
                  name: Motion Sensor
                        selector:
                                entity:
                                          domain: binary_sensor
                                                    device_class: motion
                                                        light_target:
                                                              name: Light
                                                                    selector:
                                                                            target:
                                                                                      entity:
                                                                                                  domain: light
                                                                                                      day_brightness:
                                                                                                            name: Day Brightness
                                                                                                                  default: 100
                                                                                                                        selector:
                                                                                                                                number:
                                                                                                                                          min: 0
                                                                                                                                                    max: 100
                                                                                                                                                              unit_of_measurement: "%"
                                                                                                                                                                  night_brightness:
                                                                                                                                                                        name: Night Brightness
                                                                                                                                                                              default: 20
                                                                                                                                                                                    selector:
                                                                                                                                                                                            number:
                                                                                                                                                                                                      min: 0
                                                                                                                                                                                                                max: 100
                                                                                                                                                                                                                          unit_of_measurement: "%"
                                                                                                                                                                                                                              night_start_time:
                                                                                                                                                                                                                                    name: Night Start Time
                                                                                                                                                                                                                                          default: "22:00:00"
                                                                                                                                                                                                                                                selector:
                                                                                                                                                                                                                                                        time: {}
                                                                                                                                                                                                                                                            night_end_time:
                                                                                                                                                                                                                                                                  name: Night End Time
                                                                                                                                                                                                                                                                        default: "07:00:00"
                                                                                                                                                                                                                                                                              selector:
                                                                                                                                                                                                                                                                                      time: {}
                                                                                                                                                                                                                                                                                          no_motion_wait:
                                                                                                                                                                                                                                                                                                name: Wait time
                                                                                                                                                                                                                                                                                                      description: Time to wait after last motion is detected before turning lights off.
                                                                                                                                                                                                                                                                                                            default: 120
                                                                                                                                                                                                                                                                                                                  selector:
                                                                                                                                                                                                                                                                                                                          number:
                                                                                                                                                                                                                                                                                                                                    min: 0
                                                                                                                                                                                                                                                                                                                                              max: 3600
                                                                                                                                                                                                                                                                                                                                                        unit_of_measurement: seconds

                                                                                                                                                                                                                                                                                                                                                        mode: restart
                                                                                                                                                                                                                                                                                                                                                        max_exceeded: silent

                                                                                                                                                                                                                                                                                                                                                        trigger:
                                                                                                                                                                                                                                                                                                                                                          platform: state
                                                                                                                                                                                                                                                                                                                                                            entity_id: !input motion_entity
                                                                                                                                                                                                                                                                                                                                                              from: "off"
                                                                                                                                                                                                                                                                                                                                                                to: "on"

                                                                                                                                                                                                                                                                                                                                                                action:
                                                                                                                                                                                                                                                                                                                                                                  - alias: "Turn on light with calculated brightness"
                                                                                                                                                                                                                                                                                                                                                                      service: light.turn_on
                                                                                                                                                                                                                                                                                                                                                                          target: !input light_target
                                                                                                                                                                                                                                                                                                                                                                              data:
                                                                                                                                                                                                                                                                                                                                                                                    brightness_pct: >
                                                                                                                                                                                                                                                                                                                                                                                            {% set start = states('input_datetime.night_start_time') if 'input_datetime' in (start_input | string) else (!input night_start_time) %}
                                                                                                                                                                                                                                                                                                                                                                                                    {% set end = !input night_end_time %}
                                                                                                                                                                                                                                                                                                                                                                                                            {% set now = now().strftime('%H:%M:%S') %}
                                                                                                                                                                                                                                                                                                                                                                                                                    {% if start < end %}
                                                                                                                                                                                                                                                                                                                                                                                                                              {{ (!input night_brightness) if start <= now <= end else (!input day_brightness) }}
                                                                                                                                                                                                                                                                                                                                                                                                                                      {% else %}
                                                                                                                                                                                                                                                                                                                                                                                                                                                {{ (!input night_brightness) if now >= start or now <= end else (!input day_brightness) }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        {% endif %}
                                                                                                                                                                                                                                                                                                                                                                                                                                                          - alias: "Wait for motion to stop"
                                                                                                                                                                                                                                                                                                                                                                                                                                                              wait_for_trigger:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    platform: state
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          entity_id: !input motion_entity
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                from: "on"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      to: "off"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - alias: "Wait for timeout"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            delay: !input no_motion_wait
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              - alias: "Turn off light"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  service: light.turn_off
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      target: !input light_target
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      